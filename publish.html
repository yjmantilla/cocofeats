<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Xpublish Spectrum Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <h2>Spectrum Lineplot</h2>
  <label for="epochSelect">Epoch:</label>
  <select id="epochSelect"></select>
  <label for="spaceSelect">Channel:</label>
  <select id="spaceSelect"></select>
  <div id="plot"></div>

  <script>
    const baseUrl = "http://localhost:9000";

    async function loadData() {
      // Get all coords in one request
      const coords = await fetch(`${baseUrl}/coords`).then(r => r.json());
      const freqs = coords.frequencies;
      const spaces = coords.spaces;
      const epochs = coords.epochs;
	  const da = await fetch(`${baseUrl}/data`).then(r => r.json());


      // Pull full data cube (for demo â€“ could later move to a /slice RPC)
      const ds = await fetch(`${baseUrl}/dict`).then(r => r.json());
      const values = da.data_vars.__xarray_dataarray_variable__.data;

      // Populate dropdowns
      const epochSelect = document.getElementById("epochSelect");
      epochs.forEach((ep, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.text = "Epoch " + ep;
        epochSelect.appendChild(opt);
      });

      const spaceSelect = document.getElementById("spaceSelect");
      spaces.forEach((ch, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.text = ch;
        spaceSelect.appendChild(opt);
      });

      function plotLine(epochIdx, spaceIdx) {
        const spectrum = values[epochIdx][spaceIdx];
        Plotly.newPlot("plot", [{
          x: freqs,
          y: spectrum,
          mode: "lines",
          name: `${spaces[spaceIdx]} (Epoch ${epochs[epochIdx]})`
        }], {
          title: "Spectrum",
          xaxis: { title: "Frequency (Hz)" },
          yaxis: { title: "Power" }
        });
      }

      plotLine(0, 0);

      epochSelect.addEventListener("change", () => {
        plotLine(parseInt(epochSelect.value), parseInt(spaceSelect.value));
      });
      spaceSelect.addEventListener("change", () => {
        plotLine(parseInt(epochSelect.value), parseInt(spaceSelect.value));
      });
    }

    loadData();
  </script>
</body>
</html>